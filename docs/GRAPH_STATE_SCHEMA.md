# GraphState Schema Documentation

The `GraphState` is the central "Blackboard" that stores all context for a user session. All agents read from and write to this single TypedDict.

## Core Schema

| Key | Type | Description |
| :--- | :--- | :--- |
| **Input** | | |
| `user_message` | `str` | The latest raw message from the user. |
| `session_id` | `str` | Unique UUID for the conversation session. |
| `conversation_history` | `List[Dict]` | **Accumulated** list of all past messages (User + Assistant). |
| **Control Flow** | | |
| `status` | `str` | Current workflow status: `running`, `halted`, `completed`, `error`. |
| `current_agent` | `str` | The agent currently executing (e.g., `agent_planner`). |
| `next_agent` | `str` | The agent to route to next (determined by the current agent). |
| `halt` | `bool` | `True` if the system waits for user input (e.g., "Clarifier" asked a question). |
| `plan` | `Dict` | The dynamic execution checklist generated by `PlannerAgent`. |
| **Intent & Slots** | | |
| `intent` | `str` | Classified intent: `product`, `travel`, `service`, `general`, `intro`. |
| `slots` | `Dict[str, Any]` | Extracted entities (Blackboard memory). E.g., `{"location": "Tokyo"}`. |
| `missing_slots` | `List[str]` | List of required slots that are currently empty. |
| `followups` | `List[Dict]` | Questions generated by `Clarifier` to ask the user. |
| **Search & Data** | | |
| `search_results` | `List[Dict]` | Raw results from search tools (Google, Tavily). |
| `normalized_products`| `List[Dict]` | Merged product data (Evidence + Affiliate + Rankings). |
| `affiliate_products` | `Dict` | Map of merchant -> products links (e.g., eBay items). |
| **Travel Specific** | | |
| `itinerary` | `List[Dict]` | Day-by-day travel plan (generated by `TravelItineraryAgent`). |
| `hotels` | `List[Dict]` | List of hotel options found. |
| `flights` | `List[Dict]` | List of flight options found. |
| `travel_info` | `Dict` | Enriched travel context (dates, travelers, budget). |
| **Response** | | |
| `assistant_text` | `str` | Final text response generated by `ComposerAgent`. |
| `ui_blocks` | `List[Dict]` | JSON schema for rendering UI components (Carousels, Tables). |
| `citations` | `List[str]` | References to source material (links). |
| `next_suggestions` | `List[Dict]` | Smart reply buttons for the user. |

## Key Patterns

1.  **Accumulation**: Fields annotated with `operator.add` (like `conversation_history` and `errors`) accumulate values across steps. You don't overwrite them; you return a list to append.
2.  **Persistence**: The `HaltStateManager` saves a snapshot of this state to **Redis** whenever `halt=True`.
3.  **Streaming**: The `stream_chunk_data` field is special. If an agent populates it, the Backend API immediately streams that chunk to the frontend *before* the agent finishes.

## Example State Snapshot (Travel)

```json
{
  "intent": "travel",
  "slots": {
    "destination": "London",
    "budget": "high"
  },
  "halt": true,
  "current_agent": "agent_clarifier",
  "assistant_text": "When are you planning to travel?",
  "plan": {
    "steps": [
      {"id": "search_flights", "tool": "flight_search"},
      {"id": "book_hotels", "tool": "hotel_search"}
    ]
  }
}
```
